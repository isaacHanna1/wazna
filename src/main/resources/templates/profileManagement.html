<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link th:href="@{../../css/styles.css}" rel="stylesheet" />
    <!-- Font Awesome CDN for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <title>Wazna - Profile-Management</title>
</head>
<body>
    <!-- Include the navbar fragment -->
<div th:insert="~{fragments/navbar :: mainNavbar}"></div>
    <div class="el-messiri heading-h2 text-center color-primary pad-10px">
        Profile Management
    </div>
    <div class="container profile_manage">
        <div class="status flex flx-wrap space-between">
            <div class="card ">
                Total User
                <span class="color-primary" th:text="${totalUser}"></span>
            </div>
            <div class="card ">
                Active User
                <span class="color-primary" th:text="${activeUser}"></span>
            </div>
            <div class="card ">
                Inactive User
                <span class="inactive" th:text="${inactiveUser}" ></span>
            </div>
        </div>
        <div class="filter form-element mar-bottom-5px">
            <form class="flex flx-wrap flex-mob gap-5 just-con-bet manage_filter">
                <div class="searchContainer">
                    <input type="text" placeholder="Search by UserName " class="input" id ="searchBox" name="keyword" th:value="${keyword}" autocomplete="off">
                    <input type="hidden" th:value="${searchProfileId}" name="searchProfileId" id ="searchProfileId"/>
                    <input type="hidden" th:value="${meetingId}" name="meetingId" id = "meetingId"/>
                    <input type="hidden" th:value="${churchId}" name="churchId"   id = "churchId"/>
                    <input type="hidden" th:value="${pageSize}" name="pageSize"   id = "pageSize"/>
                    <input type="hidden" th:value="${currentPage}"  name="pageNum"     id = "pageNum"/>
                    <ul id="profileSuggestion" class="dis_none profileSuggestion">                        
                    </ul>
                </div>
                <div>
                    <!--Filter by Status-->
                    <select class="input" name="status">
                        <option value="All"   th:selected="${status} == 'All'">All Status</option>
                        <option value="true"  th:selected="${status} == 'true'">Active</option>
                        <option value="false" th:selected="${status} == 'false'">Inactive</option>
                    </select>
                </div>
                    <!--Filter by Gender-->
                <div>
                        <select class="input" name="gender">
                            <option value="All"    th:selected="${gender} == 'All'">All Gender</option>
                            <option value="Male"   th:selected="${gender} == 'Male'">Male</option>
                            <option value="Female" th:selected="${gender} == 'Female'">Female</option>
                        </select>
                </div>
                <!--Filter by service Class-->
                 <div>
                        <select name="serviceClass" class="input">
                            <option value="All"> كل الفصول</option>
                            <th:block th:each="entry : ${serviceClass}">
                                <option th:value="${entry.key}" th:text="${entry.value}"
                                th:selected="${entry.key} == ${searchClass}">
                            </th:block>
                        </select>
                </div>
                <!--Filter by Role-->
                <div>
                        <select name="searchRole" class="input">
                            <option value="All"> كل الصلاحيات</option>
                            <th:block th:each="role : ${roleList}">
                                <option th:value="${role.id}" th:text="${role.name}"
                                th:selected="${role.id} == ${searchRole}">
                            </th:block>
                        </select>
                </div>
                <button type="submit" class="btn-no-width btn-primary" id="filter_btn">Filter</button>
            </form>
        </div>
        <div class="profiles">
            <table class="table">
                <thead>
                    <tr>
                        <th>SNo</th>
                        <th>Name</th>
                        <th>phone</th>
                        <th>Class</th>
                        <th>Gender</th>
                        <th>Address</th>
                        <th>Role</th>
                        <th>Enabled</th>
                        <th>Del Account</th>
                    </tr>
                </thead>
                <tbody>
            <tr th:each="profile, iterStat : ${profiles}">
                <td th:text="${iterStat.index + 1}">1</td>
                <td>
                            <a th:if="${isChildRegisterionExists}"
                            th:href="@{/child/EditProfile/{id}(id=${profile.id})}"
                            th:text="${profile.firstName + ' ' + profile.lastName}">
                            </a>
                            <a th:unless="${isChildRegisterionExists}"
                            th:href="@{/editProfile/{id}(id=${profile.id})}"
                            th:text="${profile.firstName + ' ' + profile.lastName}">
                            </a>
                </td>
                <td th:text="${profile.phone}">--</td>
                <td th:text="${profile.serviceClass}">--</td>
                <td th:text="${profile.gender}">--</td>
                <td th:text="${profile.address}">--</td>
            <td>
                <button class="btn-no-width btn-primary table_btn"
                        onclick="openRolePopup(this)"
                        th:data-fullName="${profile.firstName + ' ' + profile.lastName}"
                        th:data-userName="${profile.userName}"
                        title="Manage Roles">
                    <i class="fas fa-user-cog"></i>
                </button>    
            </td>
            <td>
                <button onclick="updateProfileStatus(this);"
                    th:class="${profile.isEnabled} ? 'btn-no-width btn-success table_btn' : 'btn-no-width btn-warning table_btn'"
                    th:attr="data-userName=${profile.userName},data-isEnabled=${profile.isEnabled}"
                    th:title="${profile.isEnabled} ? 'Disable User' : 'Enable User'">
                    <!-- Toggle switch with colors -->
                    <i th:if="${profile.isEnabled}" class="fas fa-toggle-on" style="color: green;"></i>
                    <i th:unless="${profile.isEnabled}" class="fas fa-toggle-off" style="color: red;"></i>
                </button>                    
            </td>
            <td>
                <button class="btn-no-width btn-danger table_btn"
                        onclick="showDeleteConfirmation(this)"
                        th:data-id="${profile.id}"
                        title="Delete Account"
                        style="background-color: red; color: white;">
                    <i class="fas fa-trash"></i>
                </button> 
            </td>
            </tr>
                </tbody>
            </table>
        </div>
        <div class="pagination pad-10px flex just-con-center" th:if="${numOfPages > 0}" >
            <ul class="pagination-list flex gap-5 ul-list-style-none ">
                <li th:each="pageNum : ${#numbers.sequence(1, numOfPages)}">
                <a th:href="@{/profileManage(
                            pageNum=${pageNum}, 
                            pageSize=${pageSize}, 
                            status=${status}, 
                            gender=${gender}, 
                            serviceClass=${searchClass},
                            searchRole =${searchRole}
                        )}"
                    th:classappend="${pageNum == currentPage} ? 'active-page'"
                    class="pagination-link">
                        <span th:text="${pageNum}">1</span>
                </a>
                </li>
            </ul>
        </div>
    </div>
                <!-- Change Role Modal -->
                <div id="roleModal" class="modal">
                    <div class="modal-dialog">

                        <!-- Modal Header -->
                        <div class="modal-header">
                            <h5 class="modal-title">Change User Roles</h5>
                            <span class="btn-close" onclick="closeModal()">&times;</span>
                        </div>

                        <!-- Modal Body -->
                        <div class="modal-body">
                            <p><strong>User:</strong> <span id="popup-profile-name"></span></p>
                            <div id="role-list">
                                <!-- Roles checkboxes will be loaded here via JS -->
                            </div>
                            <input type="hidden" name="userName" id="userName"/>
                        </div>

                        <!-- Modal Footer -->
                        <div class="modal-footer">
                            <button id="save-role-btn" class="btn btn-primary btn-no-width" onclick="save(this)">
                                <i class="fas fa-save"></i> Save Changes
                            </button>
                            <button onclick="closeModal()" class="btn red-col btn-no-width white-color-text">
                                <i class="fas fa-times"></i> Cancel
                            </button>
                            <div id="loadingMessage" style="display:none; color: blue;">
                                <i class="fas fa-spinner fa-spin"></i> Loading...
                            </div>
                        </div>
                    </div>
                </div>
<!-- Elegant Delete Confirmation Modal -->
<div id="deleteConfirmationModal" class="modal youth-modal">
    <div class="youth-dialog">
        <!-- Header -->
        <div class="youth-header">
            <div class="youth-warning-icon">
                <i class="fas fa-user-slash"></i>
            </div>
            <div class="youth-header-content">
                <h3 class="youth-title">Delete Account</h3>
                <p class="youth-subtitle">هذا الأجراء في حاجة إلي تاكيد </p>
            </div>
            <span class="youth-close" onclick="closeDeleteModal()">
                <i class="fas fa-times"></i>
            </span>
        </div>

        <!-- Body -->
        <div class="youth-body">
            <div class="youth-message">
                <p class="youth-warning-main">هل انت متاكد من مسح الحساب ؟</p>
                <p class="youth-warning-detail">اذا قومت بالتأكيد لا يمكن استرجاع البيانات مرة اخري</p>
            </div>
            
            <!-- Simple Verification -->
            <div class="youth-verification">
                <div class="youth-input-group">
                    <label for="confirmText">   : <strong>DELETE</strong>  للتأكيد اكتب </label>
                    <input type="text" id="confirmText" class="youth-input">
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="youth-footer">
            <button class="youth-btn youth-btn-cancel" onclick="closeDeleteModal()">
                <i class="fas fa-times"></i>
                Cancel
            </button>
            <button id="confirmDeleteBtn" class="youth-btn youth-btn-confirm" onclick="confirmDelete()" disabled>
                <i class="fas fa-trash-alt"></i>
                Delete Account
            </button>
        </div>
    </div>
</div>
    <script th:src="@{/js/nav.js}"></script>
    <script th:src="@{/js/jCommon/Common.js}"></script>
    <script th:src="@{/js/manageProfile.js}"></script>
</body>
</html>